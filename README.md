# SillyTavern 聊天历史优化扩展

一个为 SillyTavern 设计的扩展，旨在通过智能摘要角色、任务和事件信息来优化聊天历史，减少长对话中的 token 消耗，并提供可视化的设置与统计功能。

---

## 简介

本扩展通过自动提取和合并对话中的关键信息（如角色、任务和事件）来优化聊天历史结构。它能显著降低 token 使用量，从而提升长篇对话的体验。此外，它还支持自定义保留的 AI 回复数量、实时 token 统计以及解析失败的摘要提示等功能。

---

## 主要功能

- **角色/任务/事件摘要**：自动解析并合并对话中的 `<delta>` JSON 信息，生成结构化的角色、任务和事件记录。
- **智能历史裁剪**：您可以自定义保留最近 N 条 AI 的回复，而其余历史将以摘要形式保留，从而在上下文完整性与 token 节省之间取得平衡。
- **Token 统计**：实时显示当前聊天历史摘要的 token 数量，帮助您控制上下文长度。
- **失败统计**：统计并显示解析摘要失败的消息索引，便于排查问题。
- **角色信息查看器**：允许您从下拉菜单中选择一个角色，并以格式化的 JSON 对象查看其当前信息。
- **可自定义的 JSON 模板**：提供一个可自定义的模板，供 AI 在生成摘要时遵循，让您可以定义数据的结构。
- **可视化设置界面**：所有功能都可以在 SillyTavern 的扩展设置页面中直观地进行配置。

---

## 安装与使用

1.  将此扩展文件夹放入 `SillyTavern/public/scripts/extensions/third-party/` 目录下。
2.  启动 SillyTavern，进入设置页面，在“扩展”部分找到“Chat History Optimization”。
3.  勾选“启用功能”复选框以激活扩展。
4.  根据您的需要调整“正文深度”（即保留的 AI 回复数量）。

---

## 设置项说明

- **启用功能**：控制扩展启用或禁用的总开关。
- **正文深度**：设置要完整保留的最近 AI 回复的数量。其余历史将合并到摘要中。
- **Token 限制**：设置生成摘要的最大 token 限制。如果摘要超过此限制，将删除最旧的故事情节条目，直到符合限制。
- **失败的楼层**：显示解析摘要失败的消息索引。
- **Chat History Token Count**：显示当前聊天历史摘要的 token 数量。
- **JSON 模板**：一个文本区域，您可以在其中查看和编辑用于生成摘要的 JSON 模板。您可以随时将其重置为默认模板。
- **角色选择**：一个下拉菜单，用于选择角色并查看其详细信息。

---

## 技术细节

- 该扩展通过拦截聊天历史生成过程来工作。
- 它会解析每个 AI 回复中的 `<delta>` JSON 块，并将其合并到一个包含角色、任务和事件信息的全局摘要对象中。
- 它使用正则表达式和 JSON 解析来处理各种格式和边缘情况，解析失败会在界面上报告。
- 聊天历史裁剪逻辑会将整个聊天历史替换为一条包含摘要数据和最近几条 AI 回复的提示的单个用户消息。
- 摘要数据会经过进一步处理：
    - 移除已完成或已失败的任务。
    - 移除最近未被提及的角色。
    - 将绝对日期引用（例如，“第1天”）转换为相对引用（例如，“X天前”）以节省 token。
- 该扩展与 SillyTavern 的原生设置无缝集成。

---

## 贡献与反馈

- 欢迎提交 issue 或 pull request 来改进功能。
- 主页：[GitHub](https://github.com/onlyxy1986/chat-history-optimization)

---

## 作者

- only
- 版本：1.0.1 (重构版)
